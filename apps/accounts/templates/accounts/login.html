{% extends 'base.html' %}
{% load static %}

{% block title %}
Login - VoteWise
{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'accounts/css/login.css' %}" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
{% endblock %}

{% block content %}
<section class="auth-hero">
  <div class="auth-container">
    <div class="auth-card">
      
      <!-- Left Side -->
      <div class="auth-left">
        <div class="auth-branding">
          <img src="{% static 'img/logo.png' %}" alt="VoteWise Logo" class="auth-logo">
          <h2>ACLC College of Tacloban</h2>
          <h1>Welcome to VoteWise</h1>
          <p>Secure, transparent, and efficient student elections at your fingertips.</p>

          <div class="auth-features">
            <div class="feature-item">
              <i class="fas fa-shield-alt"></i>
              <span>Secure Voting</span>
            </div>
            <div class="feature-item">
              <i class="fas fa-chart-line"></i>
              <span>Live Results</span>
            </div>
            <div class="feature-item">
              <i class="fas fa-mobile-alt"></i>
              <span>Easy Access</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Side -->
      <div class="auth-right">
        <div class="auth-form-container">
          <div class="auth-header">
            <h3>Log In</h3>
            <p>Enter your credentials to access your account</p>
          </div>

          <form method="post" class="auth-form">
            {% csrf_token %}

            <!-- Username -->
            <div class="form-group">
              <label for="id_username">Student ID or Email</label>
              <div class="input-wrapper">
                <i class="fas fa-user input-icon"></i>
                {{ form.username }}
              </div>
              {% if form.username.errors %}
                <p class="error">{{ form.username.errors.0 }}</p>
              {% endif %}
            </div>

            <!-- Password -->
            <div class="form-group">
              <label for="id_password">Password</label>
              <div class="input-wrapper">
                <i class="fas fa-lock input-icon"></i>
                {{ form.password }}
                <button type="button" class="toggle-password" aria-label="Toggle Password Visibility">
                  <i class="fas fa-eye" id="password-eye-icon"></i>
                </button>
              </div>
              {% if form.password.errors %}
                <p class="error">{{ form.password.errors.0 }}</p>
              {% endif %}
            </div>

            <div class="form-options">
              <label class="checkbox-label">
                <input type="checkbox" name="remember" />
                <span class="checkmark"></span>
                Remember me
              </label>
              <a href="#" class="forgot-link">Forgot password?</a>
            </div>

            <button type="submit" class="cta-button full-width">
              <i class="fas fa-sign-in-alt"></i>
              Log In
            </button>
          </form>

          <div class="auth-footer">
            <div class="admin-login-divider">
              <span>or</span>
            </div>
            <a href="{% url 'administration:login' %}" class="admin-login-link">
              <i class="fas fa-user-shield"></i>
              <span>Election Admin Login</span>
              <i class="fas fa-arrow-right"></i>
            </a>
            
            <div class="admin-login-divider">
                <span>or</span>
            </div>
            
            <button type="button" id="faceLoginBtn" class="cta-button secondary full-width" style="background: var(--color-slate-800); margin-bottom: 1rem;">
                <i class="fas fa-camera"></i>
                Login with Face ID
            </button>
            
            <div id="faceLoginContainer" style="display: none; text-align: center; margin-bottom: 1rem;">
                <video id="video" width="320" height="240" autoplay style="border-radius: 8px; margin-bottom: 0.5rem;"></video>
                <canvas id="canvas" width="320" height="240" style="display: none;"></canvas>
                <p id="statusMsg" style="color: var(--color-slate-500); font-size: 0.9rem;">Looking for face...</p>
            </div>

            <script>
                const faceLoginBtn = document.getElementById('faceLoginBtn');
                const faceLoginContainer = document.getElementById('faceLoginContainer');
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                const statusMsg = document.getElementById('statusMsg');
                let stream = null;

                faceLoginBtn.addEventListener('click', async () => {
                    faceLoginContainer.style.display = 'block';
                    faceLoginBtn.style.display = 'none';
                    
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: true });
                        video.srcObject = stream;
                        statusMsg.textContent = "Position your face in the camera...";
                        
                        // Capture after 2 seconds
                        setTimeout(captureAndVerify, 2000);
                    } catch (err) {
                        console.error("Error accessing camera:", err);
                        statusMsg.textContent = "Camera access denied or not available.";
                    }
                });

                function captureAndVerify() {
                    statusMsg.textContent = "Verifying...";
                    const context = canvas.getContext('2d');
                    context.drawImage(video, 0, 0, 320, 240);
                    
                    const imageData = canvas.toDataURL('image/jpeg');
                    
                    fetch('/biometrics/verify/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ image: imageData })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            statusMsg.textContent = "Success! Redirecting...";
                            statusMsg.style.color = "var(--color-green)";
                            window.location.href = data.redirect_url;
                        } else {
                            statusMsg.textContent = "Face not recognized. Try again.";
                            statusMsg.style.color = "var(--color-red)";
                            // Retry after 2 seconds
                            setTimeout(captureAndVerify, 2000);
                        }
                    })
                    .catch(err => {
                        console.error("Error:", err);
                        statusMsg.textContent = "Error verifying face.";
                    });
                }
            </script>
            <div class="admin-login-divider"></div>
            <p>New to VoteWise? <a href="{% url 'accounts:register' %}" class="signup-link">Create Account</a></p>
          </div>

        </div>
      </div>

    </div>
  </div>
</section>
{% endblock %}

{% block js %}
<script src="{% static 'accounts/js/login.js' %}"></script>
{% endblock %}
