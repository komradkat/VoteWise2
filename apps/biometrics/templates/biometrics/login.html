{% extends 'base.html' %}
{% load static %}

{% block title %}
Face ID Login - VoteWise
{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'accounts/css/login.css' %}" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
    .face-login-container {
        max-width: 400px;
        margin: 0 auto;
        text-align: center;
    }
    .step-container {
        display: none;
    }
    .step-container.active {
        display: block;
    }
    .camera-feed {
        width: 100%;
        border-radius: 12px;
        background: #000;
        margin-bottom: 1rem;
        transform: scaleX(-1); /* Mirror effect */
    }
    .status-message {
        margin-top: 1rem;
        font-weight: 500;
        min-height: 24px;
    }
    .back-link {
        display: inline-block;
        margin-top: 1.5rem;
        color: var(--color-slate-500);
        text-decoration: none;
        font-size: 0.9rem;
    }
    .back-link:hover {
        color: var(--color-blue);
    }
</style>
{% endblock %}

{% block content %}
<section class="auth-hero">
  <div class="auth-container">
    <div class="auth-card" style="max-width: 500px; margin: 0 auto; display: block;">
      
      <div class="auth-form-container" style="padding: 2rem;">
        <div class="auth-header">
            <div class="icon-circle" style="background: var(--color-blue-light); color: var(--color-blue); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; font-size: 1.5rem;">
                <i class="fas fa-face-viewfinder"></i>
            </div>
            <h3>Face ID Login</h3>
            <p>Secure biometric authentication</p>
        </div>

        <!-- Step 1: Username -->
        <div id="step1" class="step-container active">
            <div class="form-group">
                <label for="username">Enter your Student ID or Email</label>
                <div class="input-wrapper">
                    <i class="fas fa-user input-icon"></i>
                    <input type="text" id="username" class="form-control" placeholder="e.g. 2023-12345" required>
                </div>
            </div>
            <button id="nextBtn" class="cta-button full-width">
                Next <i class="fas fa-arrow-right"></i>
            </button>
        </div>

        <!-- Step 2: Camera -->
        <div id="step2" class="step-container">
            <p style="color: var(--color-slate-500); margin-bottom: 1rem;">Position your face within the frame</p>
            
            <div style="position: relative; overflow: hidden; border-radius: 12px;">
                <video id="video" class="camera-feed" autoplay playsinline></video>
                <canvas id="canvas" style="display: none;"></canvas>
            </div>

            <p id="statusMsg" class="status-message">Initializing camera...</p>
            
            <button id="retryBtn" class="cta-button secondary full-width" style="display: none; margin-top: 1rem;">
                <i class="fas fa-redo"></i> Try Again
            </button>
        </div>

        <div style="text-align: center;">
            <a href="{% url 'accounts:login' %}" class="back-link">
                <i class="fas fa-arrow-left"></i> Back to Password Login
            </a>
        </div>

      </div>

    </div>
  </div>
</section>
{% endblock %}

{% block js %}
<script>
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const usernameInput = document.getElementById('username');
    const nextBtn = document.getElementById('nextBtn');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const statusMsg = document.getElementById('statusMsg');
    const retryBtn = document.getElementById('retryBtn');
    
    let stream = null;
    let username = '';

    // Step 1: Validate Username
    nextBtn.addEventListener('click', () => {
        username = usernameInput.value.trim();
        if (!username) {
            alert("Please enter your username.");
            return;
        }
        
        // Switch to Step 2
        step1.classList.remove('active');
        step2.classList.add('active');
        startCamera();
    });

    // Allow Enter key in Step 1
    usernameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            nextBtn.click();
        }
    });

    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            statusMsg.textContent = "Looking for face...";
            statusMsg.style.color = "var(--color-slate-500)";
            
            // Auto-capture after 1.5 seconds to let camera adjust
            setTimeout(captureAndVerify, 1500);
        } catch (err) {
            console.error("Error accessing camera:", err);
            statusMsg.textContent = "Camera access denied. Please enable permissions.";
            statusMsg.style.color = "var(--color-red)";
        }
    }

    function captureAndVerify() {
        statusMsg.textContent = "Verifying...";
        
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = canvas.toDataURL('image/jpeg');
        // Get CSRF token from cookie since it's not in a form
        const csrfToken = getCookie('csrftoken'); 

        fetch('/biometrics/verify/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ 
                image: imageData,
                username: username
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusMsg.textContent = "Success! Redirecting...";
                statusMsg.style.color = "var(--color-green)";
                video.style.border = "4px solid var(--color-green)";
                window.location.href = data.redirect_url;
            } else {
                statusMsg.textContent = data.error || "Face not recognized.";
                statusMsg.style.color = "var(--color-red)";
                video.style.border = "4px solid var(--color-red)";
                retryBtn.style.display = 'block';
            }
        })
        .catch(err => {
            console.error("Error:", err);
            statusMsg.textContent = "System error. Please try again.";
            statusMsg.style.color = "var(--color-red)";
            retryBtn.style.display = 'block';
        });
    }

    retryBtn.addEventListener('click', () => {
        retryBtn.style.display = 'none';
        video.style.border = "none";
        statusMsg.textContent = "Looking for face...";
        statusMsg.style.color = "var(--color-slate-500)";
        captureAndVerify();
    });

    // Helper to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
