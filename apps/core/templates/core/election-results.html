{% extends 'base.html' %}
{% load static %}

{% block title %}Election Results - VoteWise{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'core/css/election-results.css' %}">
{% endblock %}

{% block content %}
<section class="results-page">
    <div class="container">
        <!-- Page Header -->
        <div class="results-header">
            <div class="header-content">
                {% if election %}
                <div class="status-badge {% if election.is_active %}live{% else %}final{% endif %}">
                    {% if election.is_active %}
                        <span class="pulse-dot"></span>
                        <span>LIVE RESULTS</span>
                    {% else %}
                        <i class="fas fa-check-circle"></i>
                        <span>FINAL RESULTS</span>
                    {% endif %}
                </div>
                {% endif %}
                
                <h1 class="page-title">
                    {% if election %}
                        {{ election.name }}
                    {% else %}
                        Election Results
                    {% endif %}
                </h1>
                
                {% if election %}
                <p class="election-dates">
                    <i class="fas fa-calendar"></i>
                    {{ election.start_time|date:"F j, Y" }} - {{ election.end_time|date:"F j, Y" }}
                </p>
                {% endif %}
            </div>
        </div>

        {% if not election %}
        <!-- No Election State -->
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-inbox"></i>
            </div>
            <h3>No Election Data Available</h3>
            <p>There are no elections to display at this time. Please check back later.</p>
        </div>
        {% else %}

        <!-- Summary Stats -->
        <div class="summary-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Total Ballots Cast</div>
                    <div class="stat-value">{{ total_ballots|default:0 }}</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-list-check"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Positions</div>
                    <div class="stat-value">{{ positions_data|length }}</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-{{ election.is_active|yesno:'hourglass-half,flag-checkered' }}"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Status</div>
                    <div class="stat-value status-text {% if election.is_active %}active{% else %}closed{% endif %}">
                        {{ election.is_active|yesno:"Ongoing,Closed" }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Results by Position -->
        {% if positions_data %}
        <div class="positions-container">
            {% for position in positions_data %}
            <div class="position-section">
                <div class="position-header">
                    <h2 class="position-title">{{ position.name }}</h2>
                    <div class="position-meta">
                        <span class="vote-count">
                            <i class="fas fa-vote-yea"></i>
                            {{ position.total_votes }} vote{{ position.total_votes|pluralize }}
                        </span>
                    </div>
                </div>

                <div class="candidates-grid">
                    {% for candidate in position.candidates %}
                    <div class="candidate-card {% if forloop.counter == 1 and not election.is_active %}winner{% endif %}" data-rank="{{ forloop.counter }}">
                        {% if forloop.counter == 1 and not election.is_active %}
                        <div class="winner-badge">
                            <i class="fas fa-crown"></i>
                            <span>Winner</span>
                        </div>
                        {% endif %}
                        
                        <div class="candidate-rank">
                            #{{ forloop.counter }}
                        </div>
                        
                        <div class="candidate-photo">
                            <img src="{% if candidate.photo_url %}{{ candidate.photo_url }}{% else %}{% static 'core/img/default-avatar.png' %}{% endif %}"
                                 alt="{{ candidate.name }}"
                                 onerror="this.src='{% static 'core/img/default-avatar.png' %}'">
                        </div>
                        
                        <div class="candidate-info">
                            <h3 class="candidate-name">{{ candidate.name }}</h3>
                            <div class="candidate-party">
                                <i class="fas fa-flag"></i>
                                {{ candidate.partylist }}
                            </div>
                        </div>
                        
                        <div class="candidate-stats">
                            <div class="vote-info">
                                <span class="vote-count-label">Votes</span>
                                <span class="vote-count-value">{{ candidate.votes }}</span>
                            </div>
                            <div class="vote-percentage">{{ candidate.percentage }}%</div>
                        </div>
                        
                        <div class="progress-bar-container">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ candidate.percentage }}%"></div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-results">
            <i class="fas fa-info-circle"></i>
            <p>No votes have been cast yet. Results will appear here once voting begins.</p>
        </div>
        {% endif %}

        <!-- Footer Note -->
        <div class="results-footer">
            <p>
                <i class="fas fa-clock"></i>
                Last updated: {% now "F j, Y \a\t g:i A" %}
            </p>
            {% if election.is_active %}
            <p class="auto-refresh-note">
                <i class="fas fa-sync-alt"></i>
                Refresh the page to see the latest results
            </p>
            {% endif %}
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
// Add animation on scroll
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.candidate-card');
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, {
        threshold: 0.1
    });
    
    cards.forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        observer.observe(card);
    });
});
</script>
{% endblock %}